var Track=function(e,c){this.pianist=e;this.ind=c;this.noteMin=40;this.noteMax=50;this.strMin=3;this.strMax=6;this.strCurr=this.strMax;var b=[[[200,20,20,0],[200,20,20,1]],[[0,170,170,0],[0,170,170,1]]];var d=[[[70,60,60,0],[70,60,60,0.7]],[[50,80,80,0],[50,80,80,0.5]]];var a=(isMobile&&!(mobileOS=="iOS"))?d:b;this.colMin=a[(this.ind%a.length)][0];this.colMax=a[(this.ind%a.length)][1];this.colCurr=this.colMin;this.ratCol=0;this.ratColPrev=this.ratColNext=this.colMax;this.tPreNote=0.1;this.usePreRoll=false;this.arrRadius=new Array();this.v0;this.v1;this.v2;this.v3;this.beacon;this.ctPts=0;this.rotation=0;this.rotationTarg=0;this.radius=this.radiusNext=0;this.radiusLimitMax=330;this.radiusLimitMin=150;this.radiusRatio=1;this.isWarmingUp=true;this.noteInd;this.isPreRolling=false;this.isVisible=false;this.xDrawCurr;this.yDrawCurr;this.xDrawPrev;this.yDrawPrev;this.fadeInSpd=0.6;this.init()};Track.prototype.init=function(){this.cv=cv0;this.cv.lineCap="round";this.updateRadius();this.v0=makePoint(xCenter,yCenter);this.v1=makePoint(xCenter,yCenter);this.v2=makePoint(xCenter,yCenter);this.v3=makePoint(xCenter,yCenter);this.xDrawPrev=xCenter;this.yDrawPrev=yCenter};Track.prototype.noteOn=function(a){this.noteInd=arrMidiLookup[a];this.radiusNext=this.arrRadius[this.noteInd];this.radiusPrev=this.radius;if(!this.usePreRoll){this.isPreRolling=false;this.radius=this.radiusNext}else{this.isPreRolling=true;this.tPreNote0=tMaster}this.ratColPrev=this.ratCol;this.ratColNext=lim(1,0,1)};Track.prototype.upd=function(n){if(this.isPreRolling){this.tPreNote1=tMaster;var k=this.tPreNote1-this.tPreNote0;if(k>=this.tPreNote){this.radius=this.radiusNext;this.mode=0}else{this.radius=jQuery.easing.easeInOutQuart(null,k,this.radiusPrev,this.radiusNext-this.radiusPrev,this.tPreNote);this.ratCol=jQuery.easing.easeInQuad(null,k,this.ratColPrev,this.ratColNext-this.ratColPrev,this.tPreNote)}}var e=lerpColor(this.colMin,this.colMax,this.ratCol);this.colCurr=e;this.beacon.setColor(this.colCurr);var s,c;if(this.beacon.isGrabbed){var l=mouse.x-xCenter;var p=mouse.y-yCenter;var y=Math.sqrt(l*l+p*p);var f=this.radiusMax;var g=0;for(var u=this.arrRadius.length-1;u>=0;u--){if(y>this.arrRadius[u]){f=this.arrRadius[u];g=u;break}else{}}if(g==arrNotes.length-1){if(this.ind==0){g=arrNotes.length-1}else{g=arrNotes.length-2}}else{if(this.ind==0){g=g+1}}if(g!=this.noteInd){this.noteOn(arrNotes[g]);this.beacon.noteOn();if(this.isVisible){playNote(arrNotes[g],this.ind,0,false)}}var o=0.02+this.ind*0.02;this.rotationTarg=(Math.atan2(p,l))%(MATH_PI*2);this.rotation=(this.rotation+((this.rotationTarg-this.rotation)*o))%(MATH_PI*2);s=xCenter+Math.cos(this.rotation)*this.radius;c=yCenter+Math.sin(this.rotation)*this.radius}else{if(this.isWarmingUp){var d=MATH_PI/2;var m=tWarmup/TIME_WARMUP_TOTAL;this.rotation=lerp(this.rotationWarmupStart,d,Math.pow(m,0.8))}else{var q=NOTES_PER_SECOND*tMaster;this.rotation=(MATH_PI*2)*q/NOTES_IN_FULL_SPIN+MATH_PI/2}s=xCenter+Math.cos(this.rotation)*this.radius;c=yCenter+Math.sin(this.rotation)*this.radius}this.beacon.setPos(s,c);var j=s-this.xDrawPrev;var h=c-this.yDrawPrev;var x=j*j+h*h;if(x<2){return}this.v0=this.v1;this.v1=this.v2;this.v2=makePoint(s,c);var w=this.v0.x+0.5*(this.v1.x-this.v0.x);var b=this.v0.y+0.5*(this.v1.y-this.v0.y);var v=this.v1.x+0.5*(this.v2.x-this.v1.x);var a=this.v1.y+0.5*(this.v2.y-this.v1.y);if(this.ctPts<=2){this.ctPts++;return}else{if(this.isVisible){this.cv.globalCompositeOperation=(isMobile&&!(mobileOS=="iOS"))?"normal":"multiply";this.cv.beginPath();this.cv.moveTo(w,b);this.cv.quadraticCurveTo(this.v1.x,this.v1.y,v,a);this.cv.strokeStyle=getColor(this.colCurr);this.cv.lineWidth=this.strCurr;this.cv.stroke();this.cv.closePath()}}this.ratCol=lim(this.ratCol+this.fadeInSpd*n,0,1);this.xDrawPrev=s;this.yDrawPrev=c};Track.prototype.resetStroke=function(a){this.fadeInSpd=a;this.ratCol=0};Track.prototype.updateRadius=function(){var e=width<height?width:height;this.radiusMax=e*0.43;if(this.radiusMax>this.radiusLimitMax){this.radiusMax=this.radiusLimitMax}this.radiusMin=this.radiusMax*0.33;if(this.radiusMax<=this.radiusLimitMin){this.radiusRatio=0}else{this.radiusRatio=(this.radiusMax-this.radiusLimitMin)/(this.radiusLimitMax-this.radiusLimitMin)}this.strCurr=lerp(this.strMin,this.strMax,this.radiusRatio);var b=this.noteMax-this.noteMin+1;var a=(this.radiusMax-this.radiusMin)/(b-1);var d=this.radiusMin;var d;for(var c=0;c<arrNotes.length;c++){if(c>0){d+=a*(arrNotes[c]-arrNotes[c-1])}this.arrRadius[c]=d}};Track.prototype.beginWarmup=function(){this.radius=this.arrRadius[arrNotes.length-1];this.rotationWarmupStart=this.rotation=0.25*MATH_PI-Math.random()*0.1};Track.prototype.secondPianistEntered=function(){this.radius=this.arrRadius[0];this.resetStroke(0.95)};Track.prototype.setVisible=function(a){this.isVisible=a};Track.prototype.linkTo=function(a){this.beacon=a};