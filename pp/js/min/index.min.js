var MATH_PI=Math.PI;var UPDATE_INTERVAL=17;var MASTER_GAIN=0.9;var TRACK_PAN_NORMAL=0.9;var TRACK_PAN_MOBILE=0.6;var TRACK_PAN;var TIME_WARMUP_TOTAL=3;var TIME_BETWEEN_DIMMING=0.22;var NOTES_PER_BATCH=12;var SECOND_PIANIST_WAITS_FOR=4;var SECOND_PIANIST_SPEEDS_UP_FOR=8;var SECOND_PIANIST_HOLDS_FOR=8;var PIANISTS=2;var TEMPO_MASTER=199;var NOTE_LENGTH=0.5;var NOTES_PER_SECOND=TEMPO_MASTER/60/NOTE_LENGTH;var NOTES_IN_FULL_SPIN=96;var RADIANS_PER_NOTE=(2*MATH_PI)/NOTES_IN_FULL_SPIN;var TEMPO_RATIO=((SECOND_PIANIST_SPEEDS_UP_FOR*NOTES_PER_BATCH)+1)/(SECOND_PIANIST_SPEEDS_UP_FOR*NOTES_PER_BATCH);var TEMPO_SPEED_UP=TEMPO_MASTER*TEMPO_RATIO;var TIME_SPENT_WAITING=(SECOND_PIANIST_WAITS_FOR*NOTES_PER_BATCH*NOTE_LENGTH)/TEMPO_MASTER*60;var FORCE_MOBILE_FOR_TESTING=false;var arrPianists=new Array();var arrNotes=[40,42,47,49,50];var notes=arrNotes.length;var arrMidiLookup=new Array(128);var context=null;var width,height;var isComputerMuted=false;var isAboutOverlayShowing=false;var tMaster,tWarmup,tBeganPerformance,tBeganWarmup;var contextClass,context,soundLoader;var nodeSplitAutoPianist1;var nodeSplitAutoPianist2;var nodeMergeAutoPianist1;var nodeMergeAutoPianist2;var nodeGainAutoPianist1L;var nodeGainAutoPianist1R;var nodeGainAutoPianist2L;var nodeGainAutoPianist2R;var nodeSplitUserPianist1;var nodeSplitUserPianist2;var nodeMergeUserPianist1;var nodeMergeUserPianist2;var nodeGainUserPianist1L;var nodeGainUserPianist1R;var nodeGainUserPianist2L;var nodeGainUserPianist2R;var nodeCompressor;var bufferList;var worldOriginX=0;var worldOriginY=0;var t0,t1;var isWarmingUp=true;var needToInitializeCanvas=true;var cvo0,cv0,cvo1,cv1,cv2,cvo2;var isMobile;var mobileOS;var isSplashShowing=false;var useSplash=false;window.addEventListener("load",function(){if(FORCE_MOBILE_FOR_TESTING){isMobile=true}else{isMobile=mobilecheck()}mobileOS=getMobileOperatingSystem();if(mobileOS=="iOS"){useSplash=true}cvo0=document.getElementById("canvas0");cv0=cvo0.getContext("2d");cvo1=document.getElementById("canvas1");cv1=cvo1.getContext("2d");cvo2=document.getElementById("canvas2");cv2=cvo1.getContext("2d");this.elmAbout=document.getElementById("about");this.elmOverlay=document.getElementById("overlay");this.elmOverlayInner=document.getElementById("overlay-inner");this.elmSplash=document.getElementById("splash");this.elmSplashInner=document.getElementById("splash-inner");this.elmSplashImage=document.getElementById("splash-image");if(useSplash){this.elmSplash.className="show";isSplashShowing=true}contextClass=(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext);if(contextClass){context=new contextClass()}else{}nodeSplitAutoPianist1=context.createChannelSplitter(2);nodeSplitAutoPianist2=context.createChannelSplitter(2);nodeMergeAutoPianist1=context.createChannelMerger(2);nodeMergeAutoPianist2=context.createChannelMerger(2);nodeGainAutoPianist1L=context.createGain();nodeGainAutoPianist1R=context.createGain();nodeGainAutoPianist2L=context.createGain();nodeGainAutoPianist2R=context.createGain();nodeSplitUserPianist1=context.createChannelSplitter(2);nodeSplitUserPianist2=context.createChannelSplitter(2);nodeMergeUserPianist1=context.createChannelMerger(2);nodeMergeUserPianist2=context.createChannelMerger(2);nodeGainUserPianist1L=context.createGain();nodeGainUserPianist1R=context.createGain();nodeGainUserPianist2L=context.createGain();nodeGainUserPianist2R=context.createGain();nodeCompressor=context.createDynamicsCompressor();nodeCompressor.threshold.value=-30;nodeCompressor.ratio.value=2;nodeCompressor.attack.value=0.002;nodeCompressor.release.value=0.15;nodeSplitAutoPianist1.connect(nodeGainAutoPianist1L,0);nodeSplitAutoPianist1.connect(nodeGainAutoPianist1R,1);nodeSplitAutoPianist2.connect(nodeGainAutoPianist2L,0);nodeSplitAutoPianist2.connect(nodeGainAutoPianist2R,1);nodeGainAutoPianist1L.connect(nodeMergeAutoPianist1,0,0);nodeGainAutoPianist1R.connect(nodeMergeAutoPianist1,0,1);nodeGainAutoPianist2L.connect(nodeMergeAutoPianist2,0,0);nodeGainAutoPianist2R.connect(nodeMergeAutoPianist2,0,1);nodeSplitUserPianist1.connect(nodeGainUserPianist1L,0);nodeSplitUserPianist1.connect(nodeGainUserPianist1R,1);nodeSplitUserPianist2.connect(nodeGainUserPianist2L,0);nodeSplitUserPianist2.connect(nodeGainUserPianist2R,1);nodeGainUserPianist1L.connect(nodeMergeUserPianist1,0,0);nodeGainUserPianist1R.connect(nodeMergeUserPianist1,0,1);nodeGainUserPianist2L.connect(nodeMergeUserPianist2,0,0);nodeGainUserPianist2R.connect(nodeMergeUserPianist2,0,1);nodeMergeAutoPianist1.connect(nodeCompressor);nodeMergeAutoPianist2.connect(nodeCompressor);nodeMergeUserPianist1.connect(nodeCompressor);nodeMergeUserPianist2.connect(nodeCompressor);nodeCompressor.connect(context.destination);TRACK_PAN=isMobile?TRACK_PAN_MOBILE:TRACK_PAN_NORMAL;nodeGainAutoPianist1L.gain.value=TRACK_PAN*MASTER_GAIN;nodeGainAutoPianist1R.gain.value=(1-TRACK_PAN)*MASTER_GAIN;nodeGainAutoPianist2L.gain.value=(1-TRACK_PAN)*MASTER_GAIN;nodeGainAutoPianist2R.gain.value=TRACK_PAN*MASTER_GAIN;nodeGainUserPianist1L.gain.value=TRACK_PAN*MASTER_GAIN;nodeGainUserPianist1R.gain.value=(1-TRACK_PAN)*MASTER_GAIN;nodeGainUserPianist2L.gain.value=(1-TRACK_PAN)*MASTER_GAIN;nodeGainUserPianist2R.gain.value=TRACK_PAN*MASTER_GAIN;var d=new Array();var f;var b,e;for(var a=0;a<2;a++){e=a==0?"a":"b";for(var c=0;c<notes;c++){b=arrNotes[c];arrMidiLookup[b]=c;d.push("audio/piano_dual_true_stereo/piano_"+b+"_"+e+".mp3");b++}}bufferLoader=new BufferLoader(context,d,finishedLoading);bufferLoader.load();for(var c=0;c<PIANISTS;c++){arrPianists[c]=new Pianist(c,notes)}$("#splash").bind("mousedown",function(g){userEngagedSplash()}).bind("touchend",function(g){userEngagedSplash()});rsize()});var playNote=function(d,g,c,b){var e=arrMidiLookup[d];var f=context.createBufferSource();var a;f.buffer=bufferList[e];if(b){a=g==0?nodeSplitAutoPianist1:nodeSplitAutoPianist2;f.connect(a)}else{a=g==0?nodeSplitUserPianist1:nodeSplitUserPianist2;f.connect(a)}f.start(c)};var frequencyFromNoteNumber=function(a){return 440*Math.pow(2,(a-69)/12)};var finishedLoading=function(a){bufferList=a;if(!useSplash){beginWarmup()}};var userEngagedSplash=function(){if(isSplashShowing){playNote(50,0,0,true);beginWarmup();$("#splash").className="hide";$("#splash").fadeOut("fast");isSplashShowing=false}};var render=function(){t1=context.currentTime;timeDelta=t1-t0;var k=arrPianists[0].beacon;var h=arrPianists[1].beacon;var c=k.getX();var m=k.getY();var a=h.getX();var l=h.getY();var b,f,n,d;var j=20;if(c<a){b=c;f=a}else{b=a;f=c}if(m<l){n=m;d=l}else{n=l;d=m}cv1.clearRect(b-j,n-j,f-b+j*2,d-n+j*2);if(isWarmingUp){tWarmup=t1-tBeganWarmup;if(tWarmup>TIME_WARMUP_TOTAL){beginPerformance();isWarmingUp=false}else{}}else{tMaster=t1-tBeganPerformance;var g=t1-tDimmedScreenLast;if(g>TIME_BETWEEN_DIMMING){cv0.globalCompositeOperation=(isMobile&&!(mobileOS=="iOS"))?"normal":"screen";cv0.fillStyle="rgba(255, 255, 255, 0.05)";cv0.fillRect(0,0,width,height);tDimmedScreenLast=t1}}for(var e=0;e<PIANISTS;e++){arrPianists[e].upd(timeDelta,t1);arrPianists[e].track.upd(timeDelta);arrPianists[e].beacon.upd()}t0=t1;requestAnimFrame(render)};var clickedAboutLink=function(){if(!isAboutOverlayShowing){openOverlay();rsize()}};var closeOverlay=function(){for(var a=0;a<PIANISTS;a++){arrPianists[a].resumePerformance()}$("#overlay").className="hide";$("#overlay").fadeOut("fast");$("#about").className="show";$("#about").fadeIn("fast");isAboutOverlayShowing=false};var openOverlay=function(){for(var a=0;a<PIANISTS;a++){arrPianists[a].pausePerformance()}$("#overlay").className="show";$("#overlay").fadeIn("slow");$("#about").className="hide";$("#about").fadeOut("fast");isAboutOverlayShowing=true};var beginWarmup=function(){rsize();this.elmAbout.innerHTML='<a id="aboutLink" href="#" >&nbsp;&nbsp;?&nbsp;</a>';$("#about").className="show";if(mobileOS!="iOS"){$("#aboutLink").click(function(b){clickedAboutLink()});$("#overlay").on({click:function(){closeOverlay()}})}$("#aboutLink").on({touchstart:function(){clickedAboutLink()}});$("#overlay").on({touchstart:function(){closeOverlay()}});$("#dots-layer").bind("mousedown",function(c){for(var b=0;b<PIANISTS;b++){arrPianists[b].pausePerformance();arrPianists[b].beacon.startGrab()}mouse.set(c.clientX,c.clientY);$(window).bind("mousemove",drag).bind("mouseup",dragEnd)}).bind("touchstart",function(c){for(var b=0;b<PIANISTS;b++){arrPianists[b].pausePerformance();arrPianists[b].beacon.startGrab()}c.preventDefault();var d=c.originalEvent.changedTouches[0];mouse.set(d.pageX,d.pageY);$(window).bind("touchmove",touchDrag).bind("touchend",touchEnd);return false});tBeganWarmup=context.currentTime;for(var a=0;a<PIANISTS;a++){arrPianists[a].beginWarmup()}requestAnimFrame(render)};var beginPerformance=function(){tMaster=0;tDimmedScreenLast=tBeganPerformance=t0=context.currentTime;for(var a=0;a<PIANISTS;a++){arrPianists[a].beginPerformance()}};var muteComputer=function(){nodeGainAutoPianist1L.gain.value=0;nodeGainAutoPianist1R.gain.value=0;nodeGainAutoPianist2L.gain.value=0;nodeGainAutoPianist2R.gain.value=0;isComputerMuted=true};var unmuteComputer=function(){nodeGainAutoPianist1L.gain.value=TRACK_PAN*MASTER_GAIN;nodeGainAutoPianist1R.gain.value=1-TRACK_PAN*MASTER_GAIN;nodeGainAutoPianist2L.gain.value=1-TRACK_PAN*MASTER_GAIN;nodeGainAutoPianist2R.gain.value=TRACK_PAN*MASTER_GAIN;isComputerMuted=false};window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1000/60)}})();var finishedFile=function(a){bufferLoader.finishedFile(a)};var xUser,yUser,mouse=new Two.Vector(),randomness=2;var drag=function(a){xUser=a.clientX;yUser=a.clientY;mouse.set(xUser,yUser)};var dragEnd=function(b){for(var a=0;a<PIANISTS;a++){arrPianists[a].resumePerformance();arrPianists[a].beacon.stopGrab()}$(window).unbind("mousemove",drag).unbind("mouseup",dragEnd)};var touchDrag=function(a){a.preventDefault();var b=a.originalEvent.changedTouches[0];drag({clientX:b.pageX,clientY:b.pageY});return false};var touchEnd=function(b){for(var a=0;a<PIANISTS;a++){arrPianists[a].resumePerformance();arrPianists[a].beacon.stopGrab()}b.preventDefault();$(window).unbind("touchmove",touchDrag).unbind("touchend",touchEnd);return false};function makePoint(a,c){if(arguments.length<=1){c=a.y;a=a.x}var b=new Two.Vector(a,c);b.position=new Two.Vector().copy(b);return b}function getColor(e){var h=Math.round(e[0]);var f=Math.round(e[1]);var c=Math.round(e[2]);var d=(e[3]);return"rgba("+h+","+f+","+c+","+d+")"}function getColorMinusAlpha(f,e){var i=Math.round(f[0]);var h=Math.round(f[1]);var c=Math.round(f[2]);var d=e;return"rgba("+i+","+h+","+c+","+d+")"}function lerp(d,c,e){return d+(c-d)*e}function lerpColor(d,c,h){var i=lerp(d[0],c[0],h);var g=lerp(d[1],c[1],h);var f=lerp(d[2],c[2],h);var e=lerp(d[3],c[3],h);return[i,g,f,e]}function lim(c,b,a){if(c<b){return b}else{if(c>=a){return a}else{return c}}}function sign(a){if(a<0){return -1}else{return 1}}function rsize(g){var a=width;var h=height;width=window.innerWidth;height=window.innerHeight;var j=(a==width)&&(h==height);xCenter=Math.round(width/2);yCenter=Math.round(height/2);if((cvo0!=null)&&(!j||needToInitializeCanvas)){if(needToInitializeCanvas){needToInitializeCanvas=false}cvo0.width=cvo1.width=window.innerWidth;cvo0.height=cvo1.height=window.innerHeight;cv0.lineCap=cv1.lineCap="butt"}if(this.elmAbout!=null){this.elmAbout.style.left=(width-45)+"px";this.elmAbout.style.top=(height-42)+"px";var l=550;if(width>l){this.elmOverlayInner.style.width=l+"px";this.elmOverlayInner.style.left=Math.round((width-l)/2)+"px"}else{this.elmOverlayInner.style.width=width+"px";this.elmOverlayInner.style.left=0+"px"}var d=document.getElementById("overlay-inner").clientHeight;this.elmOverlayInner.style.top=(height-d)/2+"px";var b=100;var k=Math.round(width*0.7);var m;if(k<b){m=k}else{m=b}this.elmSplashInner.style.width=this.elmSplashInner.style.height=m+"px";this.elmSplashImage.style.width=this.elmSplashImage.style.height=m+"px";this.elmSplashInner.style.left=(width-m)*0.5+"px";var f=document.getElementById("splash-inner").clientHeight;this.elmSplashInner.style.top=(height-f)/2+"px"}for(var c=0;c<PIANISTS;c++){if(arrPianists[c]){arrPianists[c].track.updateRadius();arrPianists[c].track.resetStroke(0.8);arrPianists[c].beacon.updateSize()}}}function mobilecheck(){var a=false;(function(b){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4))){a=true}})(navigator.userAgent||navigator.vendor||window.opera);return a}function getMobileOperatingSystem(){var a=navigator.userAgent||navigator.vendor||window.opera;if(a.match(/iPad/i)||a.match(/iPhone/i)||a.match(/iPod/i)){return"iOS"}else{if(a.match(/Android/i)){return"Android"}else{return"Other"}}}window.addEventListener("resize",rsize,false);rsize();